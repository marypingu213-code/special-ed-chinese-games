<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¬¬å››é—œï¼šå¥å­æ’æ’ç«™</title>
    <script src="data.js"></script>
    <style>
        body { font-family: "Microsoft JhengHei", "Heiti TC", sans-serif; background-color: #eef2f5; margin: 0; display: flex; justify-content: center; align-items: center; min-height: 100vh; }
        .canvas-16-9 { width: 95vw; max-width: 1400px; aspect-ratio: 16 / 9; background-color: #fdf5e6; border-radius: 30px; box-shadow: 0 15px 35px rgba(0,0,0,0.15); display: flex; flex-direction: column; align-items: center; padding: 2% 4%; box-sizing: border-box; overflow: hidden; }
        .header-area { width: 100%; display: flex; justify-content: space-between; align-items: center; margin-bottom: 2%; }
        h1 { color: #f39c12; font-size: 2.5vw; margin: 0; text-shadow: 1px 1px 2px rgba(0,0,0,0.1); }
        .back-btn { background-color: #fff; color: #5a4a42; text-decoration: none; font-size: 1.5vw; font-weight: bold; padding: 10px 20px; border-radius: 50px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: 0.2s; }
        .back-btn:hover { background-color: #f0f0f0; transform: scale(1.05); }
        .hint-area { width: 100%; display: flex; justify-content: flex-start; margin-bottom: 2%; }
        .hint-btn { background-color: #f1c40f; border: none; border-radius: 15px; font-size: 1.8vw; font-weight: bold; color: #5a4a42; padding: 1% 3%; cursor: pointer; box-shadow: 0 6px 0 #f39c12; display: flex; align-items: center; gap: 10px; }
        .hint-btn:active { transform: translateY(6px); box-shadow: none; }
        .answer-zone { width: 100%; min-height: 15%; background-color: #fff; border: 4px dashed #f39c12; border-radius: 20px; display: flex; flex-wrap: wrap; align-content: flex-start; gap: 1vw; padding: 2%; margin-bottom: 3%; box-shadow: inset 0 4px 8px rgba(0,0,0,0.05); }
        .pool-zone { width: 100%; flex-grow: 1; background-color: #fff; border: 4px solid #f39c12; border-radius: 20px; display: flex; flex-wrap: wrap; align-content: flex-start; justify-content: center; gap: 1.5vw; padding: 3%; box-shadow: 0 8px 16px rgba(0,0,0,0.05); }
        .word-wrapper { display: flex; align-items: stretch; gap: 0.5vw; animation: popIn 0.3s ease; }
        @keyframes popIn { 0% { transform: scale(0.5); opacity: 0; } 100% { transform: scale(1); opacity: 1; } }
        .speak-btn { background-color: #fde3a7; border: none; border-radius: 10px; font-size: 1.5vw; padding: 0 1vw; cursor: pointer; box-shadow: 0 4px 0 #f39c12; transition: 0.1s; }
        .speak-btn:active { transform: translateY(4px); box-shadow: none; }
        .word-btn { background-color: #3498db; color: white; font-size: 2.5vw; font-weight: bold; font-family: inherit; border: none; border-radius: 15px; padding: 1.5vw 2.5vw; cursor: pointer; box-shadow: 0 6px 0 #2980b9; transition: all 0.1s ease; }
        .word-btn:active { transform: translateY(6px); box-shadow: none; }
        .answer-zone .word-btn { background-color: #2ecc71; box-shadow: 0 6px 0 #27ae60; }
        .answer-zone .speak-btn { background-color: #a8e6cf; box-shadow: 0 4px 0 #27ae60; }
        .shake { animation: shake 0.4s; }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-10px); } 50% { transform: translateX(10px); } 75% { transform: translateX(-10px); } 100% { transform: translateX(0); } }
        .status-area { width: 100%; height: 8%; margin-top: 2%; display: flex; justify-content: center; align-items: center; gap: 3vw; }
        #message { font-size: 2.5vw; font-weight: bold; margin: 0; color: #e74c3c; }
        #next-btn { font-size: 2vw; padding: 1% 3%; background-color: #e74c3c; color: white; border: none; border-radius: 50px; cursor: pointer; display: none; box-shadow: 0 6px 0 #c0392b; font-weight: bold; transition: 0.2s; }
        #next-btn:active { transform: translateY(6px); box-shadow: none; }
        @media (min-width: 1400px) { h1 { font-size: 36px; } .back-btn { font-size: 20px; } .hint-btn { font-size: 24px; } .word-btn { font-size: 36px; padding: 15px 25px; } .speak-btn { font-size: 24px; padding: 0 15px; } #message { font-size: 36px; } #next-btn { font-size: 28px; } }
    </style>
</head>
<body>
    <div class="canvas-16-9">
        <div class="header-area">
            <h1>ğŸš‚ ç¬¬å››é—œï¼šå¥å­æ’æ’ç«™</h1>
            <a href="#" id="back-btn" class="back-btn" onclick="stopSpeech()">ğŸ  å›èª²ç¨‹å¤§å»³</a>
        </div>
        <div class="hint-area">
            <button class="hint-btn" onclick="playFullSentence()" title="è½å®Œæ•´å¥å­">ğŸ”Š è½è½çœ‹å®Œæ•´å¥å­ (æç¤º)</button>
        </div>
        <div class="answer-zone" id="answer-zone"></div>
        <div class="pool-zone" id="pool-zone"></div>
        <div class="status-area">
            <div id="message"></div>
            <button id="next-btn" onclick="nextQuestion()">ä¸‹ä¸€é¡Œ â¡ï¸</button>
        </div>
    </div>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const lessonId = urlParams.get('id') || "2"; 
        document.getElementById('back-btn').href = `lesson.html?id=${lessonId}`;
        const questionsData = allLessonsData[lessonId] ? allLessonsData[lessonId].level4 : [];

        let currentIdx = 0, correctParts = [], poolParts = [], answerParts = [], isWaiting = false;

        function speakText(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                let spokenText = text.replace("é•·çš„", "æŒçš„");
                const utterance = new SpeechSynthesisUtterance(spokenText);
                utterance.lang = 'zh-TW'; utterance.rate = 0.85; window.speechSynthesis.speak(utterance);
            }
        }
        function stopSpeech() { if ('speechSynthesis' in window) window.speechSynthesis.cancel(); }
        function playFullSentence() { speakText(correctParts.join("")); }

        function shuffle(array) {
            let arr = [...array], curr = arr.length, rand;
            while (curr !== 0) { rand = Math.floor(Math.random() * curr); curr--; [arr[curr], arr[rand]] = [arr[rand], arr[curr]]; }
            if (arr.join("") === array.join("") && arr.length > 1) return shuffle(array);
            return arr;
        }

        function loadQuestion() {
            if (currentIdx >= questionsData.length) {
                document.getElementById('pool-zone').innerHTML = ""; document.getElementById('answer-zone').innerHTML = "";
                document.querySelector('.hint-btn').style.display = "none"; document.getElementById('message').style.color = "#2ecc71";
                document.getElementById('message').innerText = "ğŸ‰ æ­å–œï¼æœ¬é—œå¡æŒ‘æˆ°æˆåŠŸï¼"; 
                
                let btn = document.getElementById('next-btn');
                btn.innerText = 'ğŸ  å›èª²ç¨‹å¤§å»³'; btn.style.display = 'inline-block';
                btn.onclick = () => { window.location.href = `lesson.html?id=${lessonId}`; };
                speakText("æ­å–œï¼æ‰€æœ‰çš„å¥å­éƒ½æ’å®Œäº†ï¼"); return;
            }
            isWaiting = false; document.getElementById('message').innerText = ""; 
            
            let btn = document.getElementById('next-btn');
            btn.style.display = 'none'; btn.innerText = 'ä¸‹ä¸€é¡Œ â¡ï¸'; btn.onclick = nextQuestion;

            correctParts = questionsData[currentIdx].split(" "); poolParts = shuffle(correctParts); answerParts = [];
            renderZones();
        }

        function renderZones() {
            const pZone = document.getElementById('pool-zone'), aZone = document.getElementById('answer-zone');
            pZone.innerHTML = ""; aZone.innerHTML = "";
            answerParts.forEach((part, idx) => aZone.appendChild(createWordBlock(part, () => moveToPool(idx))));
            poolParts.forEach((part, idx) => pZone.appendChild(createWordBlock(part, () => moveToAnswer(idx))));
            if (poolParts.length === 0 && answerParts.length > 0) checkAnswer();
        }

        function speakText(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();
                
                // âœ¨ ç ´éŸ³å­—æ ¡æ­£é­”æ³•åŠ å¼·ç‰ˆ
                let spokenText = text.replace("é•·çš„", "æŒçš„");
                spokenText = spokenText.replace("å’Œ è‡¨å ´åæ‡‰", "æ²³ è‡¨å ´åæ‡‰"); // ğŸ‘ˆ å¹«ç¬¬ä¸‰èª²åŠ ä¸Šçš„é­”æ³•

                const utterance = new SpeechSynthesisUtterance(spokenText);
                utterance.lang = 'zh-TW'; utterance.rate = 0.85; window.speechSynthesis.speak(utterance);
            }
        }

        function moveToAnswer(idx) { if (isWaiting) return; answerParts.push(poolParts.splice(idx, 1)[0]); renderZones(); }
        function moveToPool(idx) { if (isWaiting) return; poolParts.push(answerParts.splice(idx, 1)[0]); renderZones(); }

        function checkAnswer() {
            if (answerParts.join("") === correctParts.join("")) {
                isWaiting = true; document.getElementById('message').style.color = "#2ecc71"; document.getElementById('message').innerText = "ğŸŒŸ æ’åˆ—æ­£ç¢ºï¼å¥½å²å®³ï¼";
                document.getElementById('next-btn').style.display = 'inline-block'; speakText("æ’åˆ—æ­£ç¢ºï¼å¥½å²å®³ï¼");
            } else {
                document.getElementById('message').style.color = "#e74c3c"; document.getElementById('message').innerText = "é †åºæ€ªæ€ªçš„å–”ï¼Œè«‹é»æ“Šä¸Šé¢çš„å­—é€€å›ä¾†ä¿®æ”¹ï¼";
                const aZone = document.getElementById('answer-zone'); aZone.classList.add('shake');
                setTimeout(() => aZone.classList.remove('shake'), 400); speakText("é †åºæ€ªæ€ªçš„å–”ï¼Œè«‹é»æ“Šä¸Šé¢çš„å­—é€€å›ä¾†ä¿®æ”¹ï¼");
            }
        }

        function nextQuestion() { stopSpeech(); currentIdx++; loadQuestion(); }
        window.onunload = stopSpeech; 
        window.onload = () => { if(questionsData.length===0) alert("ç„¡æ­¤é—œå¡è³‡æ–™"); else loadQuestion(); };
    </script>
</body>
</html>
